<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supabase + Leaflet Login Example</title>
<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  #map { height: 90vh; display: none; }
  #login { max-width: 300px; margin: 50px auto; }
  #login input { display: block; margin: 10px 0; padding: 8px; width: 100%; }
  #login button { padding: 8px 12px; width: 100%; cursor: pointer; }
</style>
</head>
<body>

<div id="login">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="loginUser()">Login</button>
  <p id="login-error" style="color:red;"></p>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>

<script>
  // Replace these with your project URL and anon key
  const supabaseUrl = 'https://jdkhhywfskabkpzbizbs.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impka2hoeXdmc2thYmtwemJpemJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODY3MjAsImV4cCI6MjA3MDA2MjcyMH0.u6Fd5rAuP40WUx5iQDXvpnZ7tWR5fQXLPwIDqeB5NvA';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const loginDiv = document.getElementById('login');
  const mapDiv = document.getElementById('map');
  const loginError = document.getElementById('login-error');

  // Custom Leaflet icons for active/inactive
  const greenIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
  });

  const redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
  });

  let map;
  let markersLayer;

  // Login function
  async function loginUser() {
    loginError.textContent = '';
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if (!email || !password) {
      loginError.textContent = 'Please enter email and password.';
      return;
    }

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      loginError.textContent = error.message;
    } else {
      // Hide login, show map
      loginDiv.style.display = 'none';
      mapDiv.style.display = 'block';
      loadMapAndMarkers();
    }
  }

  // Load map and markers
  async function loadMapAndMarkers() {
    if (!map) {
      map = L.map('map').setView([51.505, -0.09], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    // Clear existing markers
    markersLayer.clearLayers();

    const { data: markers, error } = await supabase.from('markers').select('*');

    if (error) {
      alert('Failed to load markers: ' + error.message);
      return;
    }

    markers.forEach(marker => {
      // Use green icon if active, red if not
      const icon = marker.active ? greenIcon : redIcon;

      const leafletMarker = L.marker([marker.lat, marker.lng], { icon }).addTo(markersLayer);

      leafletMarker.bindPopup(`
        <b>${marker.name}</b><br/>
        Active: ${marker.active ? 'Yes' : 'No'}<br/>
        <button onclick="toggleMarker(${marker.id}, ${!marker.active})">
          Turn ${marker.active ? 'Off' : 'On'}
        </button>
      `);

      leafletMarker.on('popupopen', () => {
        // Fix: attach button listener since itâ€™s in popup
        document.querySelector('button').onclick = () => {
          toggleMarker(marker.id, !marker.active);
          map.closePopup();
        };
      });
    });
  }

  // Toggle marker active state
  async function toggleMarker(id, newState) {
    const { error } = await supabase.from('markers').update({ active: newState }).eq('id', id);

    if (error) {
      alert('Failed to update marker: ' + error.message);
    } else {
      loadMapAndMarkers();
    }
  }

  // On page load, check if already logged in
  window.onload = async () => {
    const { data: { session } } = await supabase.auth.getSession();

    if (session) {
      // Logged in: hide login, show map
      loginDiv.style.display = 'none';
      mapDiv.style.display = 'block';
      loadMapAndMarkers();
    } else {
      // Not logged in: show login
      loginDiv.style.display = 'block';
      mapDiv.style.display = 'none';
    }
  };
</script>

</body>
</html>
